html(lang="en")
    head
        meta(charset="UTF-8")
        meta(name="viewport", content="width=device-width, initial-scale=1.0")
        title BSS: mix
        script(src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js")
        link(rel='stylesheet', href='../../style.css')
        link(rel="preconnect" href="https://fonts.googleapis.com")
        link(rel="preconnect" href="https://fonts.gstatic.com" crossorigin)
        link(href="https://fonts.googleapis.com/css2?family=Kanit:wght@100;200&family=Nunito:wght@200&display=swap" rel="stylesheet")
        style.
            button{
                font-size: 2rem;
            }
            .mute{
                width:2rem;
                height:2rem;
                margin:2rem;
            }
    body
        main.main__qr
            .bar
                label(for="ch1") Focus on sound 1
                input#ch1.mute(type="checkbox" checked)
                button.button#start Start
                input#ch2.mute(type="checkbox" checked)
                label(for="ch2") Focus on sound 2

    script.
        let mix = {
            channels:[new Tone.Channel(), new Tone.Channel()],
            meters:[new Tone.Meter(), new Tone.Meter()],
            filter: new Tone.Filter(200, "lowpass"),
            reverb: new Tone.Reverb(2).toDestination(),
            active:[true, true]
        }
        mix.filter.connect(mix.reverb);
        // the channels could fade to the filter/reverb according to mutes, so reverb is only used for the channels not currently going to the stereo out
        let sounds = [
            new Tone.Player("canal_II_ch_1.mp3"),
            new Tone.Player("canal_II_ch_2.mp3")
        ]
        sounds.forEach((sound,i) => {
            sound.connect(mix.channels[i]);
            sound.connect(mix.meters[i]);
            sound.connect(mix.filter);
            mix.channels[i].pan.value = 0.5 - i;
            mix.channels[i].toDestination();
        })
        
        let start = document.querySelector("#start")
        start.addEventListener("click", () => {
            sounds.forEach(sound => {
                sound.start()
            })
        })
        document.querySelectorAll('.mute').forEach((mute,i) => {
            mute.addEventListener("change", () => {
                if(mute.checked){
                    mix.active[i] = true;
                    mix.channels[i].volume.rampTo(0, 0.5)
                }else{
                    mix.active[i] = false;
                    mix.channels[i].volume.rampTo(-Infinity, 0.5)
                }
                console.log(mix.active)
                processAllChannels()
            })
        })
        
        function processAllChannels(){
            let reverbLevel = 0;
            document.querySelectorAll('.mute').forEach((mute,i)=>{
                console.log('active',mix.active[i])
                reverbLevel += mix.active[i] ? 0 : 1;
            })
            console.log(reverbLevel)
            let filterFrequency = 200 + (400 * reverbLevel);
            mix.filter.frequency.rampTo(filterFrequency, 0.5);
            console.log(filterFrequency)
            reverbLevel = Tone.gainToDb(reverbLevel);
        }