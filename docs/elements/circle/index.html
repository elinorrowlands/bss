<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>BSS: Ripples</title>

  <link rel="stylesheet" href="../../style.css">
  <link rel="stylesheet" href="./style.css">
  <link rel="stylesheet" href="./style_circles.css">
  <style>
    body{
        overflow:hidden;
        transition:all 1s ease;
        height:100vh;
        width:100vw;
    }
    
    canvas{
      -webkit-user-select: none; /* Safari */
      user-select:none;
    }
    
    #water-ripples-title{
      display:none;
    }
    
    #painting,#centeredCircle,.canBG{
      -webkit-user-select: none; /* Safari */
      user-select:none;
      width:100%; 
      position:absolute;
      margin:0;
      display:block;
      transform-origin:center;
      z-index:100;
      @media (max-width: 600px) {
       width:100%; 
       height:100%;
      
        top:0;
        transform-origin:center;
      }
    }
    
    .canBG{
        opacity:0.5;
        width:60vh;
        height:60vh;
        top:0px;
        left:0px;
        bottom:0px;
        right:0px;
        margin:auto;
        transition:all 1.5s ease;
      }
      
      #can__bg{
        transition:all 1s ease;
      }
      
  </style>
</head>

<body>
  <div id="canvas"></div>
  <div id="content">
    <div id="water-ripples">
      <div id="water-ripples-title">
        <h1 style="user-select:none;pointer-events:none;"></h1>
      </div>
      
      <svg id="centeredCircle" width="100%" height="100%" viewBox="0 0 100 100">
        <circle id="waterCircle" cx="50" cy="50" r="40" stroke="none" stroke-width="4" fill="darkblue" style="opacity:0.4;"></circle>
        <circle id="echoCircle" cx="50" cy="50" r="40" stroke="none" stroke-width="4" fill="darkblue" style="opacity:0.4;"></circle>
        <circle id="echoCircle2" cx="50" cy="50" r="40" stroke="none" stroke-width="4" fill="darkblue" style="opacity:0.4;"></circle>
      </svg>
      <img src="water_frame_0.png" alt="water" crossorigin="" data-sampler="planeTexture">
      
    </div>
  </div>
  <img id="can__bg" src="can/can_bg_900.svg" alt="background" class="canBG">
  <img id="can__0__ghost" src="can/can_0.png" class="canBG ghost" alt="can">
  <img id="can__1__ghost" src="can/can_1.png" class="canBG ghost" alt="can">
  <img id="can__0" src="can/can_0.png" class="canBG" alt="can">
  <img id="can__1" src="can/can_1.png" class="canBG" alt="can">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.7/dat.gui.min.js"></script>
  <script src="https://www.curtainsjs.com/build/curtains.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/13.4.9/Tone.min.js"></script>
  <script src="../../main.js"></script>
  <script src="./script.js" type="module" defer></script>
  <script src="./interact.js" defer></script>
  <script src="./touch.js" defer></script>

  <script>
    function checkLoaded(name) {
        const interval = 100;
        window.setTimeout(function() {
            if (window[name]) {
                window[name]();
            } else {
                checkLoaded(name);
            }
        }, interval);
    }

    const container = 'body';

    const sounds = {
        loop: new Tone.Player("../../loops/rusty_can_0.mp3"),
        meter: new Tone.Meter(),
        filter: new Tone.Filter(200, "lowpass"),
        hpf: new Tone.Filter(400, "highpass"),
        echo: new Tone.FeedbackDelay("2n", 0.5).toMaster(),
        echoMeter: new Tone.Meter()
    }

    let moused = false;
    
    sounds.echo.wet.value = 1;
    sounds.loop.volume.value=-12;
    sounds.loop.connect(sounds.filter);
    sounds.filter.Q.value = 0;
    sounds.filter.toMaster();
    sounds.filter.connect(sounds.hpf);
    sounds.hpf.connect(sounds.echo);
    sounds.echo.connect(sounds.echoMeter);
    sounds.filter.connect(sounds.meter);
    
    function setBGAnimation(){
        let i = 0, count = 0;
        setInterval( () => {
            i = i === 0 ? 1 : 0;
            count++;
            
            if(moused){
                let hue = Math.floor(count/30%100);
                $('#can__bg').css('opacity',0.1 + Tone.dbToGain(sounds.meter.getLevel())*2);
                document.body.style.filter = `hue-rotate(${Math.floor(hue)}deg) brightness(100%)`;
                // $('.canBG.ghost').css('filter',`hue-rotate(${Math.floor(hue)}deg) grayscale(${Tone.dbToGain(sounds.meter.getLevel())*1000}%)`);
                // $('.canBG.ghost').css({opacity:0.9 + Tone.dbToGain(sounds.meter.getLevel())});
                document.querySelectorAll('.canBG.ghost').forEach((el) => {
                    el.style.filter = `hue-rotate(${Math.floor(hue)}deg) grayscale(${Tone.dbToGain(sounds.meter.getLevel())*1000}%)`;
                    el.style.transform = `scale(${0.9 + Tone.dbToGain(sounds.meter.getLevel())*1})`;
                    el.style.opacity = 0.9 + Tone.dbToGain(sounds.meter.getLevel());
                })
                // console.log(0.9 + Tone.dbToGain(sounds.meter.getLevel()))
            } else {
                $('#can__bg').css('opacity',0.5 + Tone.dbToGain(sounds.meter.getLevel()));
                document.body.style.filter = `hue-rotate(0deg)`;
                $('.canBG.ghost').css('opacity',0.4 + Tone.dbToGain(sounds.meter.getLevel()));
                $('.canBG.ghost').css('opacity',0);
            }
           
            $('#waterCircle').css('opacity',0.1 + Tone.dbToGain(sounds.meter.getLevel()));
            $('#waterCircle').css('transform', `scale(${0.1 + Tone.dbToGain(sounds.meter.getLevel())*4})`);
            $('#can__0').css('transform', `scale(${0.9 + Tone.dbToGain(sounds.meter.getLevel())*1})`);
            $('#can__bg').css('transform', `scale(${0.9 + Tone.dbToGain(sounds.meter.getLevel())*1})`);
            $('#echoCircle').css('transform', `scale(${0 + Tone.dbToGain(sounds.echoMeter.getLevel())*6})`);
            $('#can__1').css('transform', `scale(${0.9 + Tone.dbToGain(sounds.echoMeter.getLevel())*1.3})`);
            $('#echoCircle2').css('transform', `scale(${0 + Tone.dbToGain(sounds.echoMeter.getLevel())*10})`);
            
        }, 30)
    }
    
    setBGAnimation();
    
    let started = false;
    
    window.addEventListener('mousedown', (e) => {
      Tone.start();
      sounds.loop.loop = true;
      if(!started){
          sounds.loop.start();    
          started = true;
      }
     sounds.filter.frequency.rampTo(1000, 1);
     moused = true;   

    });
    
    window.addEventListener('mouseup',(e) => {
        sounds.filter.frequency.rampTo(200, 1);
        moused=false;
    });
    
    Tone.start();
    
    let loadScript = loadingIndicator.init();
    checkLoaded('addBackButton');
    
    
  </script>
</body>
</html>